# 配置用户或者组，默认为nobody nobody。
user nobody nobody;
# 允许生成的进程数，默认为1
worker_processes 1;
# 制定日志路径，级别。这个设置可以放入全局块，http块，server块，级别依次为：debug|info|notice|warn|error|crit|alert|emerg
error_log logs/error.log error;
# 指定nginx进程运行文件存放地址
pid logs/nginx.pid;


# events块
events {
    # 设置网路连接序列化，防止惊群现象发生，默认为on
    accept_mutex off;
    # 设置一个进程是否同时接受多个网络连接，默认为off
    multi_accept off;
    # 最大连接数，默认为512
    worker_connections 512;
}
# http块
http {
    # 文件扩展名与文件类型映射表
    include;
    # 默认文件类型，默认为text/plain
    default_type text/plain;
    log_format combined "..."; # 重点了解

    access_log logs/access.log combined;

    sendfile off;
    tcp_nopush off;
    keepalive_timeout 75s;
    underscores_in_headers off;
    client_header_timeout 60s;
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    send_timeout 60s;
    proxy_max_temp_file_size 1024m;
    proxy_request_buffering on;

    gzip off;
    gzip_min_length 20;
    gzip_http_version 1.1;
    gzip_buffers 32 4k|16 8k;
    gzip_types text/html;
    gzip_comp_level 1;
    gzip_vary off;
    # IE6对Gzip不怎么友好，不给它Gzip了
    gzip_disable "MSIE [1-6]\."

    # 拒绝的ip(考虑通过include 引入文件方式引入)
    deny 127.0.0.2;
    deny 127.0.0.3;

    # upstream负载均衡算法
    upstream wp_lease_conn {
        ip_hash;
        server 10.158.1.10:8901;
        server 10.158.1.20:8901;
        server 10.158.1.30:8901;
    }

    #该作用主要是根据客户端请求中$http_upgrade 的值，来构造改变$connection_upgrade的值，即根据变量$http_upgrade的值创建新的变量$connection_upgrade，
    #如果 $http_upgrade 不为 '' (空),则 $connection_upgrade 为 upgrade,如果 $http_upgrade 为 '' (空),则 $connection_upgrade 为 close
    #websocket
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    # server块
    server {
        listen *:80 | *:8000;

        location / {
            rewrite / /test1;
        }

        location /test1 {
            proxy_set_header Host $host;
            proxy_set_header Connection close;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_http_version 1.0;
            proxy_pass http://wp_lease_conn;
        }

        #表示监听 /test/websocket/
        location ^~/ws/websocket/ {
            #表示代理转发到 upstream wp_ip_hash
            proxy_pass http://wp_ip_hash;
            #表示传递时请求头不变, $host是nginx内置变量,表示的是当前的请求头,proxy_set_header表示设置请求头
            proxy_set_header Host $host;
            # 表示传递时来源的ip还是现在的客户端的ip
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # 表示反向代理发送的HTTP协议的版本是1.1,HTTP1.1支持长连接(websocket)
            proxy_http_version 1.1;
            # 表示设置Upgrade不变(websocket)
            proxy_set_header Upgrade $http_upgrade;
            #表示如果 $http_upgrade为upgrade,则请求为upgrade(websocket),如果不是,就关闭连接
            proxy_set_header Connection "upgrade";
        }

        location = /demoProject {
            root html;
            index demoProject/index.html;
        }
    }

    server {
        #监听443端口
        listen 443;
        ssl on;
        #申请域名对应的证书
        ssl_certificate /etc/ssl/yin.com_bundle.crt;
        #申请域名对应的密匙
        ssl_certificate_key /etc/ssl/yin.com.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;
        ssl_prefer_server_ciphers on;
        location /test1 {
            #表示传递时请求头不变, $host是nginx内置变量,表示的是当前的请求头,proxy_set_header表示设置请求头
            proxy_set_header Host $host;
            # 表示传递时来源的ip还是现在的客户端的ip
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            # 表示反向代理发送的HTTP协议的版本是1.1,HTTP1.1支持长连接(websocket)
            proxy_http_version 1.1;
            # 表示设置Upgrade不变(websocket)
            proxy_set_header Upgrade $http_upgrade;
            #表示如果 $http_upgrade为upgrade,则请求为upgrade(websocket),如果不是,就关闭连接
            proxy_set_header Connection "upgrade";
            #表示代理转发到 upstream wp_ip_hash
            proxy_pass http://wp_lease_conn;
        }
    }
}

